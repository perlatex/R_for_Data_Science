# tidyverseä¸­çš„across()ä¹‹ç¾ {#beauty-of-across}


dplyr 1.0ç‰ˆæœ¬å¢åŠ äº†`across()`å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é›†ä¸­ä½“ç°äº†dplyrå®åŒ…çš„å¼ºå¤§å’Œç®€çº¦ï¼Œä»Šå¤©æˆ‘ç”¨ä¼é¹…æ•°æ®ï¼Œæ¥é¢†ç•¥å®ƒçš„ç¾ã€‚



```{r beauty-of-across-1, message=FALSE, warning=FALSE}
library(tidyverse)
library(palmerpenguins)
penguins
```

çœ‹åˆ°æ•°æ®æ¡†é‡Œæœ‰å¾ˆå¤šç¼ºå¤±å€¼ï¼Œéœ€è¦ç»Ÿè®¡æ¯ä¸€åˆ—ç¼ºå¤±å€¼çš„æ•°é‡ï¼ŒæŒ‰ç…§å¸¸è§„çš„å†™æ³•


```{r beauty-of-across-2}
penguins %>%
  summarise(
    na_in_species = sum(is.na(species)),
    na_in_island  = sum(is.na(island)),
    na_in_length  = sum(is.na(bill_length_mm)),
    na_in_depth   = sum(is.na(bill_depth_mm)),
    na_in_flipper = sum(is.na(flipper_length_mm)),
    na_in_body    = sum(is.na(body_mass_g)),
    na_in_sex     = sum(is.na(sex)),
    na_in_year    = sum(is.na(year))
  )
```
å¹¸äºæ•°æ®æ¡†çš„åˆ—æ•°ä¸å¤Ÿå¤šï¼Œåªæœ‰8åˆ—ï¼Œå¦‚æœæ•°æ®æ¡†æœ‰å‡ ç™¾åˆ—ï¼Œé‚£å°±æˆä½“åŠ›æ´»äº†ï¼ŒåŒæ—¶ä»£ç å¤åˆ¶ç²˜è´´ä¹Ÿå®¹æ˜“å‡ºé”™ã€‚æƒ³å·æ‡’ï¼Œæˆ‘ä»¬è‡ªç„¶æƒ³åˆ°ç”¨`summarise_all()`ï¼Œ

```{r beauty-of-across-3}
penguins %>%
  summarise_all(
    ~ sum(is.na(.))
  )
```

æŒºå¥½ã€‚æ¥ç€æ¢ç´¢ï¼Œæˆ‘ä»¬æƒ³å…ˆæŒ‰ä¼é¹…ç±»å‹åˆ†ç»„ï¼Œç„¶åç»Ÿè®¡å‡ºå„ä½“å¾æ•°æ®çš„å‡å€¼ï¼Œè¿™ä¸ªå¥½è¯´ï¼Œç›´æ¥å†™ä»£ç 

```{r beauty-of-across-4}
penguins %>%
  group_by(species) %>%
  summarise(
    mean_length   = mean(bill_length_mm, na.rm = TRUE),
    mean_depth    = mean(bill_depth_mm, na.rm = TRUE),
    mean_flipper  = mean(flipper_length_mm, na.rm = TRUE),
    mean_body     = mean(body_mass_g, na.rm = TRUE)
  )
```

æˆ–è€…ç”¨`summarise_if()`å·æ‡’


```{r beauty-of-across-5}
d1 <- penguins %>%
  group_by(species) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
d1
```


æ–¹æ³•ä¸é”™ï¼Œä»è¯­ä¹‰ä¸Šè¿˜ç®—å¾ˆå¥½ç†è§£ã€‚ ä½†å¤šäº†ä¸€åˆ—`year`, æˆ‘æƒ³åœ¨`summarise_if()`ä¸­ç”¨ `is.numeric & !year`å»æ‰`year`ï¼Œå´æ²¡æˆåŠŸã€‚äººç±»çš„æ¬²æœ›æ˜¯æ— ç©·çš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»Ÿè®¡æ¯ç»„ä¸‹ä¼é¹…çš„ä¸ªæ•°ï¼Œç„¶ååˆå¹¶åˆ°ä¸€èµ·ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å†æ¥å†å‰


```{r beauty-of-across-6}
d2 <- penguins %>%
  group_by(species) %>%
  summarise(
    n = n()
  )
d2
```

æœ€ååˆå¹¶
```{r beauty-of-across-7}
d1 %>% left_join(d2, by = "species")
```

ç»“æœåº”è¯¥æ²¡é—®é¢˜ï¼Œç„¶é¹…ï¼Œæ€»è®©äººæ„Ÿè§‰æ€ªæ€ªçš„ï¼Œè¿‡ç¨‹æœ‰ç‚¹æŠ˜è…¾ï¼Œå¸Œæœ›ä¸è¿™ä¹ˆéº»çƒ¦ã€‚



## across()æ¨ªç©ºå‡ºä¸–

`across()`çš„å‡ºç°ï¼Œè®©è¿™ä¸€åˆ‡å˜å¾—ç®€å•å’Œæ¸…æ™°ï¼Œä¸Šé¢ä¸‰æ­¥å®Œæˆçš„åŠ¨ä½œï¼Œä¸€æ­¥æå®š

```{r beauty-of-across-8, out.width = '75%', echo = FALSE}
knitr::include_graphics("images/across_cover.jpg")
```


```{r beauty-of-across-9}
penguins %>%
  group_by(species) %>%
  summarise(
    across(where(is.numeric) & !year, mean, na.rm = TRUE),
    n = n()
  )
```
æ˜¯ä¸æ˜¯å¾ˆå¼ºå¤§ã€‚å¤§çˆ±Hadley Wickham !!!

## across()å‡½æ•°å½¢å¼

`across()`å‡½æ•°ï¼Œå®ƒæœ‰ä¸‰ä¸ªä¸»è¦çš„å‚æ•°ï¼š
```{r beauty-of-across-10, eval = FALSE}
across(.cols = , .fns = , .names = )
```

- ç¬¬ä¸€ä¸ªå‚æ•°.cols = ï¼Œé€‰å–æˆ‘ä»¬è¦éœ€è¦çš„è‹¥å¹²åˆ—ï¼Œé€‰å–å¤šåˆ—çš„è¯­æ³•ä¸`select()`çš„è¯­æ³•ä¸€è‡´ï¼Œé€‰æ‹©æ–¹æ³•éå¸¸ä¸°å¯Œå’Œäººæ€§åŒ–

   - åŸºæœ¬è¯­æ³•
      - `:`ï¼Œå˜é‡åœ¨ä½ç½®ä¸Šæ˜¯è¿ç»­çš„ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼ `1:3` æˆ–è€…` species:island`
      - `!`ï¼Œå˜é‡åå‰åŠ !ï¼Œæ„æ€æ˜¯æ±‚è¿™ä¸ªå˜é‡çš„è¡¥é›†ï¼Œç­‰ä»·äºå»æ‰è¿™ä¸ªå˜é‡ï¼Œæ¯”å¦‚`!species`
      - `&` ä¸ `|`ï¼Œä¸¤ç»„å˜é‡é›†çš„äº¤é›†å’Œå¹¶é›†ï¼Œæ¯”å¦‚ `is.numeric & !year`, å°±æ˜¯é€‰å–æ•°å€¼ç±»å‹å˜é‡ï¼Œä½†ä¸åŒ…æ‹¬`year`; å†æ¯”å¦‚ `is.numeric | is.factor`å°±æ˜¯é€‰å–æ•°å€¼å‹å˜é‡å’Œå› å­å‹å˜é‡
      - `c()`ï¼Œé€‰å–å˜é‡çš„ç»„åˆï¼Œæ¯”å¦‚`c(a, b, x)`
   
   - é€šè¿‡äººæ€§åŒ–çš„è¯­å¥
     - `everything()`: é€‰å–æ‰€æœ‰çš„å˜é‡
     - `last_col()`: é€‰å–æœ€åä¸€åˆ—ï¼Œä¹Ÿå°±è¯´å€’æ•°ç¬¬ä¸€åˆ—ï¼Œä¹Ÿå¯ä»¥`last_col(offset = 1L)` å°±æ˜¯å€’æ•°ç¬¬äºŒåˆ—
     
   - é€šè¿‡å˜é‡åçš„ç‰¹å¾
      - `starts_with()`: æŒ‡å®šä¸€ç»„å˜é‡åçš„å‰ç¼€ï¼Œä¹Ÿå°±æŠŠé€‰å–å…·æœ‰è¿™ä¸€å‰ç¼€çš„å˜é‡ï¼Œ`starts_with("bill_")`
      - `ends_with()`: æŒ‡å®šä¸€ç»„å˜é‡åçš„åç¼€ï¼Œä¹Ÿå°±é€‰å–å…·æœ‰è¿™ä¸€åç¼€çš„å˜é‡ï¼Œ`ends_with("_mm")`
      - `contains()`: æŒ‡å®šå˜é‡åå«æœ‰ç‰¹å®šçš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯é€‰å–å«æœ‰æŒ‡å®šå­—ç¬¦ä¸²çš„å˜é‡ï¼Œ`ends_with("length")`
      - `matches()`: åŒä¸Šï¼Œå­—ç¬¦ä¸²å¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼
   
   - é€šè¿‡å­—ç¬¦ä¸²å‘é‡
     - `all_of()`: é€‰å–å­—ç¬¦ä¸²å‘é‡å¯¹åº”çš„å˜é‡åï¼Œæ¯”å¦‚`all_of(c("species", "sex",    "year"))`ï¼Œå½“ç„¶å‰ææ˜¯ï¼Œæ•°æ®æ¡†ä¸­è¦æœ‰è¿™äº›å˜é‡ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚
     - `any_of()`: åŒ`all_of()`ï¼Œåªä¸è¿‡æ•°æ®æ¡†ä¸­æ²¡æœ‰å­—ç¬¦ä¸²å‘é‡å¯¹åº”çš„å˜é‡ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œæ¯”å¦‚æ•°æ®æ¡†ä¸­æ²¡æœ‰peopleè¿™ä¸€åˆ—ï¼Œä»£ç `any_of(c("species", "sex", "year", "people"))`ä¹Ÿæ­£å¸¸è¿è¡Œï¼ŒæŒºäººæ€§åŒ–çš„
   
   
   - é€šè¿‡å‡½æ•°
     - å¸¸è§çš„æœ‰æ•°æ®ç±»å‹å‡½æ•° `where(is.numeric), where(is.factor), where(is.character), where(is.date)`
    


- ç¬¬äºŒä¸ªå‚æ•°`.fns =`ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œçš„å‡½æ•°ï¼ˆæˆ–è€…å¤šä¸ªå‡½æ•°ï¼‰ï¼Œå‡½æ•°çš„è¯­æ³•æœ‰ä¸‰ç§å½¢å¼å¯é€‰ï¼š
  - A function, e.g. `mean`.
  - A purrr-style lambda, e.g. `~ mean(.x, na.rm = TRUE)`
  - A list of functions/lambdas, e.g. `list(mean = mean, n_miss = ~ sum(is.na(.x))`
  
- ç¬¬ä¸‰ä¸ªå‚æ•°`.names =`, å¦‚æœ`.fns`æ˜¯å•ä¸ªå‡½æ•°å°±é»˜è®¤ä¿ç•™åŸæ¥æ•°æ®åˆ—çš„åç§°ï¼Œå³`"{.col}"` ï¼›å¦‚æœ`.fns`æ˜¯å¤šä¸ªå‡½æ•°ï¼Œå°±åœ¨æ•°æ®åˆ—çš„åˆ—ååé¢è·Ÿä¸Šå‡½æ•°åï¼Œæ¯”å¦‚`"{.col}_{.fn}"`ï¼›å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç®€å•è°ƒæ•´åˆ—åå’Œå‡½æ•°ä¹‹é—´çš„é¡ºåºæˆ–è€…å¢åŠ ä¸€ä¸ªæ ‡è¯†çš„å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚å¼„æˆ`"{.fn}_{.col}"`ï¼Œ`"{.col}_{.fn}_aa"`




## across()åº”ç”¨ä¸¾ä¾‹

ä¸‹é¢é€šè¿‡ä¸€äº›å°æ¡ˆä¾‹ï¼Œç»§ç»­å‘ˆç°`across()`å‡½æ•°çš„åŠŸèƒ½


### æ±‚æ¯ä¸€åˆ—çš„ç¼ºå¤±å€¼æ•°é‡

å°±æ˜¯æœ¬ç« å¼€å§‹çš„éœ€æ±‚
```{r beauty-of-across-11, eval=FALSE}
penguins %>%
  summarise(
    na_in_species = sum(is.na(species)),
    na_in_island  = sum(is.na(island)),
    na_in_length  = sum(is.na(bill_length_mm)),
    na_in_depth   = sum(is.na(bill_depth_mm)),
    na_in_flipper = sum(is.na(flipper_length_mm)),
    na_in_body    = sum(is.na(body_mass_g)),
    na_in_sex     = sum(is.na(sex)),
    na_in_year    = sum(is.na(year))
  )
```


```{r beauty-of-across-12}
# using across()
penguins %>%
  summarise(
    across(everything(), function(x) sum(is.na(x)))
  )


# or
penguins %>%
  summarise(
    across(everything(), ~ sum(is.na(.)))
  )
```





### æ¯ä¸ªç±»å‹å˜é‡ä¸‹æœ‰å¤šå°‘ç»„ï¼Ÿ

```{r beauty-of-across-13}
penguins %>%
  summarise(
    distinct_species = n_distinct(species),
    distinct_island  = n_distinct(island),
    distinct_sex     = n_distinct(sex)
  )

# using across()
penguins %>%
  summarise(
    across(c(species, island, sex), n_distinct)
  )
```








### å¤šåˆ—å¤šä¸ªç»Ÿè®¡å‡½æ•°


```{r beauty-of-across-14}
penguins %>%
  group_by(species) %>%
  summarise(
    length_mean  = mean(bill_length_mm, na.rm = TRUE),
    length_sd    = sd(bill_length_mm, na.rm = TRUE),
    depth_mean   = mean(bill_depth_mm, na.rm = TRUE),
    depth_sd     = sd(bill_depth_mm, na.rm = TRUE),
    flipper_mean = mean(flipper_length_mm, na.rm = TRUE),
    flipper_sd   = sd(flipper_length_mm, na.rm = TRUE),
    n            = n()
  )


# using across()
penguins %>%
  group_by(species) %>%
  summarise(
    across(ends_with("_mm"), list(mean = mean, sd = sd), na.rm = TRUE),
    n = n()
  )
```





### ä¸åŒåˆ†ç»„ä¸‹æ•°æ®å˜é‡çš„å¤šä¸ªåˆ†ä½æ•°

äº‹å®ä¸Šï¼Œè¿™é‡Œæ˜¯`across()`ä¸`summarise()`çš„å¼ºå¤§ç»“åˆèµ·æ¥


```{r beauty-of-across-15}
penguins %>%
  group_by(species, island) %>%
  summarise(
    prob    = c(.25, .75),
    length  = quantile(bill_length_mm, prob, na.rm = TRUE),
    depth   = quantile(bill_depth_mm, prob, na.rm = TRUE),
    flipper = quantile(flipper_length_mm, prob, na.rm = TRUE)
  )


# using across()
penguins %>%
  group_by(species, island) %>%
  summarise(
    prob = c(.25, .75),
    across(
      c(bill_length_mm, bill_depth_mm, flipper_length_mm),
      ~ quantile(., prob, na.rm = TRUE)
    )
  )


# or
penguins %>%
  group_by(species, island) %>%
  summarise(
    prob = c(.25, .75),
    across(where(is.numeric) & !year, ~ quantile(., prob, na.rm = TRUE))
  )
```




### ä¸åŒåˆ†ç»„ä¸‹æ›´å¤æ‚çš„ç»Ÿè®¡

```{r beauty-of-across-16}
# using across()
penguins %>%
  group_by(species) %>%
  summarise(
    n = n(),
    across(starts_with("bill_"), mean, na.rm = TRUE),
    Area = mean(bill_length_mm * bill_depth_mm, na.rm = TRUE),
    across(ends_with("_g"), mean, na.rm = TRUE),
  )
```



### æ•°æ®æ ‡å‡†åŒ–å¤„ç†

```{r beauty-of-across-17}
std <- function(x) {
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}

# using across()
penguins %>%
  summarise(
    across(where(is.numeric), std),
    across(where(is.character), as.factor)
  )


# using across() and purrr style
penguins %>%
  drop_na() %>% 
  summarise(
    across(starts_with("bill_"), ~ (.x - mean(.x)) / sd(.x))
  )
```





### æ•°æ®å¯¹æ•°åŒ–å¤„ç†

```{r beauty-of-across-18}
# using across()
penguins %>%
  drop_na() %>%
  mutate(
    across(where(is.numeric), log),
    across(where(is.character), as.factor)
  )

# using across()
penguins %>%
  drop_na() %>%
  mutate(
    across(where(is.numeric), .fns = list(log = log), .names = "{.fn}_{.col}"),
    across(where(is.character), as.factor)
  )
```





### åœ¨åˆ†ç»„å»ºæ¨¡ä¸­ä¸`cur_data()`é…åˆä½¿ç”¨


```{r beauty-of-across-19}
penguins %>%
  group_by(species) %>%
  summarise(
    broom::tidy(lm(bill_length_mm ~ bill_depth_mm, data = cur_data()))
  )


penguins %>%
  group_by(species) %>%
  summarise(
    broom::tidy(lm(bill_length_mm ~ ., data = cur_data() %>% select(is.numeric)))
  )



penguins %>%
  group_by(species) %>%
  summarise(
    broom::tidy(lm(bill_length_mm ~ .,
                data = cur_data() %>% transmute(across(is.numeric))
    ))
  )


penguins %>%
  group_by(species) %>%
  summarise(
    broom::tidy(lm(bill_length_mm ~ ., data = across(is.numeric)))
  )
```



### ä¸`cur_column()`é…åˆä½¿ç”¨


```{r beauty-of-across-20}
# æ¯ä¸€åˆ—ä¹˜ä»¥å„è‡ªçš„ç³»æ•°
df   <- tibble(x = 1:3, y = 3:5, z = 5:7)
mult <- list(x = 1, y = 10, z = 100)

df %>% 
  mutate(across(all_of(names(mult)), ~ .x * mult[[cur_column()]]))




# æ¯ä¸€åˆ—ä¹˜ä»¥å„è‡ªçš„æƒé‡
df      <- tibble(x = 1:3, y = 3:5, z = 5:7)
weights <- list(x = 0.2, y = 0.3, z = 0.5)

df %>%
  mutate(
    across(all_of(names(weights)),
           list(wt = ~ .x * weights[[cur_column()]]),
          .names = "{col}.{fn}"
    )
  )



# æ¯ä¸€åˆ—æœ‰å„è‡ªçš„é˜ˆå€¼ï¼Œå¦‚æœåœ¨é˜ˆå€¼ä¹‹ä¸Šä¸º1ï¼Œå¦åˆ™ä¸º 0
df      <- tibble(x = 1:3, y = 3:5, z = 5:7)
cutoffs <- list(x = 2, y = 3, z = 7)

df %>% mutate(
  across(all_of(names(cutoffs)), ~ if_else(.x > cutoffs[[cur_column()]], 1, 0))
)
```




### ä¸`c_across()`é…åˆä¹ŸæŒºé»˜å¥‘

```{r beauty-of-across-21}
df <- tibble(x = 1:3, y = 3:5, z = 5:7)

df %>%
  rowwise() %>%
  mutate(total = sum(c_across(x:z))) %>%
  ungroup() %>%
  mutate(across(x:z, ~ . / total))
```







## across()æ€»ç»“

æˆ‘ä»¬çœ‹åˆ°äº†ï¼Œ`across()`å‡½æ•°åœ¨`summarise()/mutate()/transmute()/condense()`ä¸­ä½¿ç”¨ï¼Œå®ƒèƒ½å®ç°ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š

- æ•°æ®æ¡†ä¸­çš„å¤šåˆ—æ‰§è¡Œç›¸åŒæ“ä½œ
- ä¸åŒæ€§è´¨çš„æ“ä½œï¼Œæœ‰æ—¶å¯ä»¥ä¸€èµ·å†™å‡ºï¼Œä¸ç”¨å†`left_join()`

```{r beauty-of-across-22, out.width = '90%', echo = FALSE, fig.cap = "across()å‡½æ•°æ€»ç»“å›‘ù<U+3E65>"}
knitr::include_graphics("images/across.png")
```



```{r beauty-of-across-23, echo = F}
# remove the objects
# ls() %>% stringr::str_flatten(collapse = ", ")

rm(cutoffs, d1, d2, df, mult, std, weights)
```



```{r beauty-of-across-24, echo = F, message = F, warning = F, results = "hide"}
pacman::p_unload(pacman::p_loaded(), character.only = TRUE)
```

