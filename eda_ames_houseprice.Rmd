# æ¢ç´¢æ€§æ•°æ®åˆ†æ-amesæˆ¿å±‹ä»·æ ¼ {#eda-ames-houseprice}




## æ•°æ®æ•…äº‹

```{r eda-ames-houseprice-1, out.width = '75%', echo = FALSE, fig.cap = "è¿™æ˜¯æ•°æ®æ•…äº‹çš„åœ°å›‘ù<U+3E65>"}
knitr::include_graphics("images/ames.png")
```


è¿™æ˜¯ä¸€ä»½**Ames**æˆ¿å±‹[æ•°æ®](https://www.kaggle.com/c/house-prices-advanced-regression-techniques)ï¼Œæ‚¨å¯ä»¥æŠŠå®ƒæƒ³è±¡ä¸ºæˆ¿å±‹ä¸­ä»‹æ¨å‡ºçš„æˆéƒ½å¸‚æ­¦ä¾¯åŒºã€é”¦æ±ŸåŒºä»¥åŠé«˜æ–°åŒºç­‰å„åŒºå¿çš„æˆ¿å±‹ä¿¡æ¯

```{r eda-ames-houseprice-2, message=FALSE, warning=FALSE}
library(tidyverse)
ames <- read_csv("./demo_data/ames_houseprice.csv") %>% 
        janitor::clean_names()

glimpse(ames)
```





æ„Ÿè°¢æ›¾å€¬åŒå­¦æä¾›çš„è§£é‡Šè¯´æ˜æ–‡æ¡£
```{r eda-ames-houseprice-3}
explanation <- readxl::read_excel("./demo_data/ames_houseprice_explanation.xlsx")
explanation %>% 
  knitr::kable()
```

## æ¢ç´¢è®¾æƒ³

- è¯»æ‡‚æ•°æ®æè¿°ï¼Œæ¯”å¦‚
  - æˆ¿å±‹è®¾æ–½ (bedrooms, garage, fireplace, pool, porch, etc.),
  - åœ°ç†ä½ç½® (neighborhood),
  - åœŸåœ°ä¿¡æ¯ (zoning, shape, size, etc.),
  - å“ç›¸ç­‰çº§
  - å‡ºå”®ä»·æ ¼
  

- æ¢ç´¢å½±å“æˆ¿å±‹ä»·æ ¼çš„å› ç´ 
  - å¿…è¦çš„é¢„å¤„ç†ï¼ˆç¼ºå¤±å€¼å¤„ç†ã€æ ‡å‡†åŒ–ã€å¯¹æ•°åŒ–ç­‰ç­‰ï¼‰
  - å¿…è¦çš„å¯è§†åŒ–ï¼ˆæ¯”å¦‚ä»·æ ¼åˆ†å¸ƒå›¾ç­‰ï¼‰
  - å¿…è¦çš„ç»Ÿè®¡ï¼ˆæ¯”å¦‚å„åœ°åŒºæˆ¿å±‹ä»·æ ¼çš„å‡å€¼ï¼‰
  - åˆç†é€‰å–è‹¥å¹²é¢„æµ‹å˜é‡ï¼Œå»ºç«‹å¤šå…ƒçº¿æ€§æ¨¡å‹ï¼Œå¹¶å¯¹æ¨¡å‹ç»“æœç»™å‡ºè§£é‡Š
  - æˆ¿å±‹ä»·æ ¼ä¸é¢„æµ‹å˜é‡ï¼ˆæˆ¿å±‹å¤§å°ã€åœ¨åŸå¸‚çš„ä½ç½®ã€æˆ¿å±‹ç±»å‹ã€ä¸è¡—é“çš„è·ç¦»ï¼‰



## å˜é‡é€‰å–

```{r eda-ames-houseprice-4}
d <- ames %>% 
  select(sale_price, 
         lot_frontage,   # å»ºç­‘ç¦»è¡—é“çš„è·ç¦»
         lot_area,       # å åœ°é¢ç§¯
         neighborhood,   # å»ºç­‘åœ¨åŸå¸‚çš„ä½ç½®
         gr_liv_area,    # åœ°ä¸Šå±…ä½é¢ç§¯
         bldg_type,      # ä½å®…ç±»åˆ«(è”æ’åˆ«å¢…ã€ç‹¬æ ‹åˆ«å¢…...)
         year_built      # æˆ¿å±‹ä¿®å»ºæ—¥æœŸ
         )
d
```






## ç¼ºå¤±å€¼å¤„ç†

```{r eda-ames-houseprice-5}
d %>% 
  summarise(
    across(everything(), function(x) sum(is.na(x)) )
  )
```



æ‰¾å‡ºæ¥çœ‹çœ‹
```{r eda-ames-houseprice-6}
d %>% 
  filter_all(
    any_vars(is.na(.))
  )
```


```{r eda-ames-houseprice-7, eval=FALSE}
library(visdat)

d %>% vis_dat()
```



å¦‚æœä¸é€‰æ‹©`lot_frontage` å°±ä¸ä¼šæœ‰ç¼ºå¤±å€¼ï¼Œå¦‚ä½•é€‰æ‹©ï¼Œè‡ªå·±æŠ‰æ‹©

```{r eda-ames-houseprice-8, eval=FALSE}
d %>% 
  select(-lot_frontage) %>% 
  visdat::vis_dat()
```


æˆ‘ä¸ªäººè§‰å¾—è¿™ä¸ªå˜é‡å¾ˆé‡è¦ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¿ç•™ï¼Œç‰ºç‰²ä¸€ç‚¹æ ·æœ¬é‡å§
```{r eda-ames-houseprice-9}
d <- d %>% 
  drop_na()
```


```{r eda-ames-houseprice-10, eval=FALSE}
d %>% visdat::vis_dat()
```






## é¢„å¤„ç†

- æ ‡å‡†åŒ–

```{r eda-ames-houseprice-11}
standard <- function(x) {
  (x - mean(x)) / sd(x)
}

d %>% 
  mutate(
    across(where(is.numeric), standard),
    across(where(is.character), as.factor)
  )
```


- å¯¹æ•°åŒ–

```{r eda-ames-houseprice-12}
d %>% 
  mutate(
    log_sale_price = log(sale_price)
  )
```


```{r eda-ames-houseprice-13}
d %>% 
  mutate(
    across(where(is.numeric), log),
    across(where(is.character), as.factor)
  )
```


- æ ‡å‡†åŒ– vs å¯¹æ•°åŒ–

é€‰æ‹©å“ªä¸€ç§ï¼Œæˆ‘ä»¬çœ‹å›¾è¯´è¯

```{r eda-ames-houseprice-14}
d %>% 
  ggplot(aes(x = sale_price)) +
  geom_density()
```


```{r eda-ames-houseprice-15}
d %>% 
  ggplot(aes(x = log(sale_price))) +
  geom_density()
```



æˆ‘ä»¬é€‰æ‹©å¯¹æ•°åŒ–ï¼Œå¹¶ä¿å­˜ç»“æœ
```{r eda-ames-houseprice-16}
d <- d %>% 
  mutate(
    across(where(is.numeric), 
           .fns = list(log = log), 
           .names = "{.fn}_{.col}"
           ),
    across(where(is.character), as.factor)
  )
```





## å¼€å§‹æ¢ç´¢


### å„åŒºåŸŸçš„æˆ¿å±‹ä»·æ ¼å‡å€¼

```{r eda-ames-houseprice-17}
d %>% count(neighborhood)
```



```{r eda-ames-houseprice-18}
d %>% 
  group_by(neighborhood) %>% 
  summarise(
    mean_sale = mean(sale_price)
  ) %>% 
  
  ggplot(
    aes(x = mean_sale, y = fct_reorder(neighborhood, mean_sale))
  ) +
  geom_col(aes(fill = mean_sale < 150000), show.legend = FALSE) +
  geom_text(aes(label = round(mean_sale, 0)), hjust = 1) +
  # scale_x_continuous(
  #   expand = c(0, 0),
  #   breaks = c(0, 100000, 200000, 300000),
  #   labels = c(0, "1w", "2w", "3w")    
  #   ) +
  scale_x_continuous(
    expand = c(0, 0),
    labels = scales::dollar
  ) +
  scale_fill_viridis_d(option = "D") + 
  theme_classic() +
  labs(x = NULL, y = NULL)
```



### æˆ¿å±‹ä»·æ ¼ä¸å åœ°é¢ç§¯

```{r eda-ames-houseprice-19}
d %>%
  ggplot(aes(x = log_lot_area, y = log_sale_price)) +
  geom_point(colour = "blue") +
  geom_smooth(method = lm, se = FALSE, formula = "y ~ x")
```





```{r eda-ames-houseprice-20}
d %>%
  ggplot(aes(x = log_lot_area, y = log_sale_price)) +
  geom_point(aes(colour = neighborhood)) +
  geom_smooth(method = lm, se = FALSE, formula = "y ~ x")
```





```{r eda-ames-houseprice-21}
d %>%
  ggplot(aes(x = log_lot_area, y = log_sale_price)) +
  geom_point(colour = "blue") +
  geom_smooth(method = lm, se = FALSE, formula = "y ~ x", fullrange = TRUE) +
  facet_wrap(~neighborhood) +
  theme(strip.background = element_blank())
```



### æˆ¿å±‹ä»·æ ¼ä¸æˆ¿å±‹å±…ä½é¢ç§¯

```{r eda-ames-houseprice-22}
d %>%
  ggplot(aes(x = log_gr_liv_area, y = log_sale_price)) +
  geom_point(aes(colour = neighborhood)) +
  geom_smooth(method = lm, se = FALSE, formula = "y ~ x")
```


```{r eda-ames-houseprice-23}
d %>%
  ggplot(aes(x = log_gr_liv_area, y = log_sale_price)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE, formula = "y ~ x", fullrange = TRUE) +
  facet_wrap(~neighborhood) +
  theme(strip.background = element_blank())
```



## å»ºæ¨¡

```{r eda-ames-houseprice-24}
lm(log_sale_price ~ 1 + log_gr_liv_area + neighborhood, data = d) %>% 
  broom::tidy()
```


```{r eda-ames-houseprice-25}
library(lme4)
lmer(log_sale_price ~ 1 + log_gr_liv_area + (log_gr_liv_area | neighborhood), 
    data = d) %>% 
   broom.mixed::tidy()
```



```{r eda-ames-houseprice-26, echo = F}
# remove the objects
# ls() %>% stringr::str_flatten(collapse = ", ")
rm(ames, d, explanation)
```



```{r eda-ames-houseprice-27, echo = F, message = F, warning = F, results = "hide"}
pacman::p_unload(pacman::p_loaded(), character.only = TRUE)
```
