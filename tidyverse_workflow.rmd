# å›æœ›tidyverseä¹‹æ—… {#workflow}

```{r tidyverse-workflow-1}
library(tidyverse)
```

å‰é¢å‡ ç« å…ˆåä»‹ç»äº†tidyverseå¥—é¤çš„è‹¥å¹²éƒ¨ä»¶ã€‚æ„Ÿè§‰å¾ˆéš¾å—ï¼Ÿå¦‚æœæ˜¯ï¼Œé‚£è¯´æ˜ä½ è®¤çœŸå¬äº†ã€‚

æœ¬ç« åšä¸ªå°ç»“ï¼Œé€šè¿‡æ¡ˆä¾‹**å¤ä¹ å’Œä¸²è®²**ä¸‹tidyverseä¸­å¸¸ç”¨çš„æ ¸å¿ƒéƒ¨ä»¶ï¼ˆäº‹å®ä¸Šï¼Œtidyverseå¥—é¤æ¯”æˆ‘ä»¬åˆ—å‡ºçš„è¦ä¸°å¯Œï¼‰ã€‚


```{r tidyverse-workflow-2, out.width='100%', fig.cap = "å›¾ç‰‡æ¥æºSilvia CanelÃ³nåœ¨R-Ladies Chicagoçš„æŠ¥å‘<U+383C><U+3E61>", echo=FALSE}
knitr::include_graphics("images/tidyverse-workflow.png")
```




## readr å®åŒ…
```{r tidyverse-workflow-3, out.width='20%', fig.align='left', echo = FALSE}
knitr::include_graphics("images/hex/readr.png")
```

è¯»å…¥æ•°æ®æ˜¯ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨`readr`å¯¼å…¥æ•°æ®

```{block tidyverse-workflow-4, type="danger"}
æç¤ºï¼š

- é€—å·(`,`)åˆ†å‰²çš„æ–‡ä»¶ `read_csv()`
- åˆ¶è¡¨ç¬¦(`tab`)åˆ†å‰²çš„æ–‡ä»¶ `read_tsv()`
- ä»»æ„çš„åˆ†å‰²ç¬¦ `read_delim()`
- å›ºå®šå®½åº¦çš„æ–‡ä»¶ `read_fwf()`
- ç©ºæ ¼åˆ†å‰²çš„æ–‡ä»¶ `read_table()`
- ç½‘é¡µlogæ–‡ä»¶ `read_log()` 
```




è¯»å–å¤–éƒ¨æ•°æ®
```{r tidyverse-workflow-5}
penguins <- read_csv("./demo_data/penguins.csv") 
```


ä¿å­˜åˆ°å¤–éƒ¨æ–‡ä»¶
```{r tidyverse-workflow-6, eval=FALSE}
penguins %>% write_csv("newdata.csv")
```



## tibble å®åŒ…
```{r tidyverse-workflow-7, out.width='20%', fig.align='left', echo = FALSE}
knitr::include_graphics("images/hex/tibble.png")
```

`tibble` æ˜¯å‡çº§ç‰ˆçš„ `dataframe`, ä¹‹æ‰€ä»¥æ˜¯å‡çº§ç‰ˆï¼Œæ˜¯å› ä¸ºåœ¨`tidyverse`ä¸­`tibble`åšå¾ˆå¤šä¼˜åŒ–ã€‚ä¸‹é¢ä½ å¯ä»¥çœ‹åˆ°ä¸¤è€…çš„åŒºåˆ«ï¼š


```{r tidyverse-workflow-8}
as_tibble(penguins)
as.data.frame(penguins) %>% head()
```

åœ¨R Markdowné‡Œä¸¤è€…åŒºåˆ«ä¸å¤§ï¼Œä½†åœ¨consoleä¸­ï¼ŒåŒºåˆ«å¾ˆæ˜æ˜¾çš„ã€‚æ¯”å¦‚`tibble`ä¸ä¸€æ ·çš„åœ°æ–¹æœ‰ï¼š

- åˆ—å‡ºäº†å˜é‡çš„ç±»å‹(è¿™ä¸ªå¾ˆä¸é”™)
- åªåˆ—å‡º10è¡Œ
- åªåˆ—å‡ºæœ‰é™çš„åˆ—æ•°ï¼ˆä¸å±å¹•é€‚åº”çš„ï¼‰
- é«˜äº® `NAs`



## ggplot2 å®åŒ…
```{r tidyverse-workflow-9, out.width='20%', fig.align='left', echo = FALSE}
knitr::include_graphics("images/hex/ggplot2.png")
```



### æŸ¥çœ‹æ•°æ®

æˆ‘ä»¬å…ˆæŸ¥çœ‹ä¸‹æ•°æ®
```{r tidyverse-workflow-10}
glimpse(penguins)
```

### æ•£ç‚¹å›¾

ä½“é‡åœ¨æ€§åˆ«ä¸Šæœ‰å¾ˆå¤§åŒºåˆ«ï¼Ÿ
```{r tidyverse-workflow-11}
ggplot(data = penguins, aes(x = sex, y = body_mass_g)) +
  geom_point()
```


### ç®±çº¿å›¾

```{r tidyverse-workflow-12}
ggplot(data = penguins, aes(x = sex, y = body_mass_g)) +
  geom_boxplot()
```


```{r tidyverse-workflow-13}
ggplot(data = penguins, aes(x = sex, y = body_mass_g)) +
  geom_boxplot(aes(fill = species))
```


æˆ‘ä»¬å¯èƒ½çœ‹åˆ°ï¼š

- Gentoo ç±»çš„ä¼é¹… æ¯” Adelie å’Œ Chinstrap ç±»çš„ä¼é¹…ä½“é‡æ›´é‡
- Gentoo ç±»å‹ä¸­ï¼Œé›„æ€§ä¼é¹…æ¯”é›Œæ€§ä¼é¹…ä½“é‡æ›´é‡
- Adelie å’Œ Chinstrap ä¸¤ç§ç±»å‹çš„ä¼é¹…ï¼ŒåŒºåˆ«ä¸æ˜¯å¾ˆæ˜æ˜¾
- sex è¿™ä¸ªå˜é‡æœ‰ç¼ºå¤±å€¼ï¼Œä¸»è¦é›†ä¸­åœ¨ Gentoo å’Œ Chinstrap ä¸¤ç§ç±»å‹


é‚£ä¹ˆæ¯ç§ç±»å‹çš„ä¼é¹…ï¼Œæ•°æ®ä¸­æœ‰å¤šå°‘æ˜¯`NA`å‘¢ï¼Ÿ ä¸Š`dplyr`å§ï¼


## dplyr å®åŒ…
```{r tidyverse-workflow-14, out.width='20%', fig.align='left', echo = FALSE}
knitr::include_graphics("images/hex/dplyr.png")
```


dplyr å®åŒ…å¯ä»¥:

- åˆ›å»ºæ–°å˜é‡ `mutate()`
- åˆ†ç»„ç»Ÿè®¡ `summarize() + group_by()`
- ç­›é€‰ `filter()`
- é‡å‘½åå˜é‡ `rename()`
- æ’åº `arrange()`
- æ›´å¤š




### é€‰å–åˆ—

ä¸‹é¢ä¸¤ä¸ªæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

```{r tidyverse-workflow-15}
select(penguins, species, sex, body_mass_g)
```


```{r tidyverse-workflow-16}
penguins %>%
  select(species, sex, body_mass_g)
```



### è¡Œæ–¹å‘æ’åº

```{r tidyverse-workflow-17}
glimpse(penguins)
```


```{r tidyverse-workflow-18}
penguins %>%
  select(species, sex, body_mass_g) %>%
  arrange(desc(body_mass_g))
```



### åˆ†ç»„ç»Ÿè®¡

```{r tidyverse-workflow-19}
penguins %>% 
  group_by(species, sex) %>%
  summarize(count = n())
```


### å¢åŠ åˆ—

```{r tidyverse-workflow-20}
penguins %>% 
  group_by(species) %>%
  mutate(count_species = n()) %>%
  ungroup() %>%
  group_by(species, sex, count_species) %>%
  summarize(count = n()) %>%
  mutate(prop = count/count_species*100)
```


### ç­›é€‰

```{r tidyverse-workflow-21}
penguins %>% 
  group_by(species) %>%
  mutate(count_species = n()) %>%
  ungroup() %>%
  group_by(species, sex, count_species) %>%
  summarize(count = n()) %>%
  mutate(percentage = count/count_species*100) %>%
  filter(species == "Chinstrap")
```




## forcats å®åŒ…

```{r tidyverse-workflow-22, out.width='20%', fig.align='left', echo = FALSE}
knitr::include_graphics("images/hex/forcats.png")
```

`forcats` å®åŒ…ä¸»è¦ç”¨äºåˆ†ç±»å˜é‡å’Œå› å­å‹å˜é‡ï¼Œæ¯”å¦‚è¿™é‡Œçš„ `species, island, sex`.


å¯¹äºä¸æ˜¯å› å­å‹çš„å˜é‡ï¼Œæ¯”å¦‚è¿™é‡Œ `year` æ˜¯æ•°å€¼å‹å˜é‡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ `factor()` å‡½æ•° å°†å®ƒè½¬æ¢æˆå› å­å‹å˜é‡ã€‚

```{r tidyverse-workflow-23}
penguins %>%
  mutate(year_factor = factor(year, levels = unique(year)))
```


æˆ‘ä»¬ä¿å­˜åˆ°æ–°çš„æ•°æ®é›†ä¸­ï¼Œå†çœ‹çœ‹æœ‰ä»€ä¹ˆå˜åŒ–

```{r tidyverse-workflow-24}
penguins_new <-
  penguins %>%
  mutate(year_factor = factor(year, levels = unique(year)))
penguins_new
```



```{r tidyverse-workflow-25}
class(penguins_new$year_factor)

levels(penguins_new$year_factor)
```

å¤§å®¶å›æƒ³ä¸‹ï¼Œå¼„æˆå› å­å‹å˜é‡æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ


## stringr å®åŒ…

```{r tidyverse-workflow-26, out.width='20%', fig.align='left', echo = FALSE}
knitr::include_graphics("images/hex/stringr.png")
```

`stringr`å®åŒ…åŒ…å«äº†éå¸¸ä¸°å¯Œçš„**å¤„ç†å­—ç¬¦ä¸²**çš„å‡½æ•°ï¼Œæ¯”å¦‚

- åŒ¹é…
- å­—ç¬¦ä¸²å­é›†
- å­—ç¬¦ä¸²é•¿åº¦
- å­—ç¬¦ä¸²åˆå¹¶
- å­—ç¬¦ä¸²åˆ†å‰²
- æ›´å¤š

### å­—ç¬¦ä¸²è½¬æ¢

```{r tidyverse-workflow-27}
penguins %>%
  select(species, island) %>%
  mutate(ISLAND = str_to_upper(island))
```

### å­—ç¬¦ä¸²åˆå¹¶

```{r tidyverse-workflow-28}
penguins %>%
  select(species, island) %>%
  mutate(ISLAND = str_to_upper(island)) %>%
  mutate(species_island = str_c(species, ISLAND, sep = "_"))
```




## tidyr å®åŒ…

```{r tidyverse-workflow-29, out.width='20%', fig.align='left', echo = FALSE}
knitr::include_graphics("images/hex/stringr.png")
```

æƒ³æƒ³ä»€ä¹ˆå«tidy dataï¼Ÿ


### é•¿è¡¨æ ¼å˜å®½è¡¨æ ¼

```{r tidyverse-workflow-30}
untidy_penguins <-
  penguins %>%
    pivot_wider(names_from = sex,
                values_from = body_mass_g)
untidy_penguins
```


### å®½è¡¨æ ¼å˜é•¿è¡¨æ ¼


```{r tidyverse-workflow-31}
untidy_penguins %>%
  pivot_longer(cols = male:`NA`, 
               names_to = "sex",
               values_to = "body_mass_g")
```




## purrr å®åŒ…

```{r tidyverse-workflow-32, out.width='20%', fig.align='left', echo = FALSE}
knitr::include_graphics("images/hex/purrr.png")
```

`purrr` å®åŒ…æä¾›äº†`map()`ç­‰ä¸€ç³»åˆ—å‡½æ•°ï¼Œå–ä»£ `for` å’Œ `while`å¾ªç¯æ–¹å¼ï¼Œå®ç°é«˜æ•ˆè¿­ä»£ï¼Œä¿æŒè¯­æ³•ä¸€è‡´æ€§ï¼ŒåŒæ—¶å¢å¼ºäº†ä»£ç çš„å¯è¯»æ€§ã€‚



```{r tidyverse-workflow-33}
penguins %>% map(~sum(is.na(.)))
```


```{r tidyverse-workflow-34}
penguins %>%
  group_nest(species) %>%
  mutate(model = purrr::map(data, ~ lm(bill_depth_mm ~ bill_length_mm, data = .))) %>%
  mutate(result = purrr::map(model, ~ broom::tidy(.))) %>%
  tidyr::unnest(result)
```



```{r tidyverse-workflow-35, echo = F}
# remove the objects
# rm(list=ls())
rm(penguins, penguins_new, untidy_penguins)
```


```{r tidyverse-workflow-36, echo = F, message = F, warning = F, results = "hide"}
pacman::p_unload(pacman::p_loaded(), character.only = TRUE)
```
