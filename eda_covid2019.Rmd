# æ¢ç´¢æ€§æ•°æ®åˆ†æ-æ–°å† ç–«æƒ… {#eda-covid2019}


```{r eda-covid2019-1, message = FALSE, warning = FALSE}
library(tidyverse)
library(lubridate)
library(maps)
library(viridis)
library(ggrepel)
library(paletteer)
library(shadowtext)
library(showtext)
showtext_auto()
```



æ–°å‹å† çŠ¶ç—…æ¯’ï¼ˆä¿—ç§°æ­¦æ±‰è‚ºç‚ï¼‰ç–«æƒ…åœ¨å¤šå›½è”“å»¶ï¼Œæœ¬ç« é€šè¿‡åˆ†æ[ç–«æƒ…æ•°æ®](https://github.com/CSSEGISandData/COVID-19)ï¼Œäº†è§£ç–«æƒ…å‘å±•ï¼Œç¥æ„¿äººç±»æ—©æ—¥ä¼šæˆ˜èƒœç—…æ¯’ï¼



```{r eda-covid2019-2, out.width='45%', fig.align='left', fig.cap='ç”µå½±ã€Šä¼ æŸ“ç—…ã€<U+383C><U+3E62>,ã€Šæµæ„Ÿã€‹æµ·æŠõ<U+3E35>', echo=FALSE}
knitr::include_graphics(c("images/movie_contagion.jpg", "images/movie_flu.png"))
```

## æ•°æ®æ¥æº

æˆ‘ä»¬æ‰“å¼€é“¾æ¥[https://github.com/CSSEGISandData/COVID-19](https://github.com/CSSEGISandData/COVID-19)ï¼Œ

```{r eda-covid2019-3, out.width='85%', fig.align='left', echo = F}
knitr::include_graphics("images/github_COVID-19_download.png")
```


æ‰¾åˆ°ç–«æƒ…æ—¶é—´åºåˆ—æ•°æ®ï¼Œä½ å¯ä»¥é€šè¿‡ç‚¹å‡»è¯¥ç½‘é¡µ`Clone or download`ç›´æ¥ä¸‹è½½çš„æ–¹å¼è·å–æ•°æ®ã€‚

```{r eda-covid2019-4, out.width='85%', fig.align='left', echo = F}
knitr::include_graphics("images/github_COVID-19_files.png")
```


## è¯»å–æ•°æ®

å‡å®šä½ å·²ç»ä¸‹è½½äº†æ•°æ®ï¼Œæ¯”å¦‚`time_series_covid19_confirmed_global.csv`ï¼Œ é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨`readr::read_csv()`å‡½æ•°ç›´æ¥è¯»å–, å…³äºåœ¨Rè¯­è¨€é‡Œæ–‡ä»¶è¯»å–çš„æ–¹æ³•å¯ä»¥å‚è€ƒç¬¬ \@ref(readr) ç« ã€‚




```{r eda-covid2019-5}
d <- read_csv("./demo_data/time_series_covid19_confirmed_global.csv")
d
```

## æ•°æ®é›†ç»“æ„

æ¢ç´¢æ•°æ®ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸€å®šè¦å¯¹æ•°æ®**å­˜å‚¨ç»“æ„ã€æ•°æ®å˜é‡ååŠå…¶å«ä¹‰**è¦éå¸¸æ¸…æ¥šï¼Œé‡è¦çš„äº‹æƒ…è¯´ä¸‰éã€‚


```{r eda-covid2019-6}
glimpse(d)
```




## æ•°æ®æ¸…æ´—è§„æ•´


### å¿…è¦çš„é¢„å¤‡çŸ¥è¯†ä¹‹`select()`

```{r eda-covid2019-7, eval = FALSE}
d %>% select(-c(1:4))
d %>% select(5:ncol(.))
d %>% select(matches("/20"))
d %>% select(ends_with("/20"))

# åº”è¯¥è¿˜æœ‰å…¶ä»–çš„æ–¹æ³•
```



### å¿…è¦çš„é¢„å¤‡çŸ¥è¯†ä¹‹`pivot_longer()`

**å®½è¡¨æ ¼**å˜**é•¿è¡¨æ ¼**ï¼Œéœ€è¦ç”¨åˆ°`pivot_longer()` å’Œ `pivot_wider()`ï¼Œ æ¯”å¦‚

```{r eda-covid2019-8, out.width='99%', fig.align='left', echo = F}
knitr::include_graphics("images/pivot.png")
```


```{r eda-covid2019-9}
table4a
```


```{r eda-covid2019-10}
longer <- table4a %>%
  pivot_longer(
    cols = `1999`:`2000`,
    names_to = "year",
    values_to = "cases"
  )

longer
```


### å¿…è¦çš„é¢„å¤‡çŸ¥è¯†ä¹‹`pivot_wider()`

æœ‰æ—¶å€™æˆ‘ä»¬æƒ³æŠ˜è…¾ä¸‹ï¼Œæ¯”å¦‚æŠŠ**é•¿è¡¨æ ¼**å†å˜å›**å®½è¡¨æ ¼**

```{r eda-covid2019-11}
longer %>%
  pivot_wider(
    names_from = year,
    values_from = cases
  )
```

### å¿…è¦çš„é¢„å¤‡çŸ¥è¯†ä¹‹æ—¥æœŸæ ¼å¼

æœ‰æ—¶å€™ï¼Œæˆ‘ä¼šé‡åˆ°æ—¥æœŸ`date`è¿™ç§æ•°æ®ç±»å‹ï¼Œæˆ‘æ¨èä½¿ç”¨`lubridate`åŒ…æ¥å¤„ç†ï¼Œæ¯”å¦‚

```{r eda-covid2019-12}
c("2020-3-25", "20200325", "20-03-25", "2020 03 25") %>% lubridate::ymd()
```


```{r eda-covid2019-13}
c("3/25/20", "03-25-20", "3-25/2020") %>% lubridate::mdy()
```

é‡åˆ°è¿™ç§`010210`æ—¥æœŸçš„ï¼Œè¯·æŠŠè¾“å…¥æ•°æ®çš„äººæ‰ä¸€é¡¿ï¼Œä»–ä¼šå‘Šè¯‰ä½ çš„

```{r eda-covid2019-14, eval=FALSE}
lubridate::dmy(010210)
lubridate::dym(010210)
lubridate::mdy(010210)
lubridate::myd(010210)
lubridate::ymd(010210)
lubridate::ydm(010210)
```


### å¿…è¦çš„é¢„å¤‡çŸ¥è¯†ä¹‹æ—¶é—´å·®

```{r eda-covid2019-15}
difftime(ymd("2020-03-24"),
  ymd("2020-03-23"),
  units = "days"
)
```

æˆ–è€…æ›´ç›´è§‚çš„è¡¨è¿°
```{r eda-covid2019-16}
ymd("2020-03-24") - ymd("2020-03-23")
```


è½¬æ¢ä¸ºå¤©æ•°
```{r eda-covid2019-17}
(ymd("2020-03-24") - ymd("2020-03-23")) %>% as.numeric()
```

### æœ‰æ—¶å€™éœ€è¦log10_scale

```{r eda-covid2019-18, out.width = '100%'}
tb <- tibble(
  days_since_100 = 0:18,
  cases = 100 * 1.33^days_since_100
)


p1 <- tb %>%
  ggplot(aes(days_since_100, cases)) +
  geom_line(size = 0.8) +
  geom_point(pch = 21, size = 1)

p2 <- tb %>%
  ggplot(aes(days_since_100, log10(cases))) +
  geom_line(size = 0.8) +
  geom_point(pch = 21, size = 1)


p3 <- tb %>%
  ggplot(aes(days_since_100, cases)) +
  geom_line(size = 0.8) +
  geom_point(pch = 21, size = 1) +
  scale_y_log10()

library(patchwork)
p1 + p2 + p3
```

### æ•°æ®æ¸…æ´—è§„æ•´

```{r eda-covid2019-19}
d1 <- d %>%
  pivot_longer(
    cols = 5:ncol(.),
    names_to = "date",
    values_to = "cases"
  ) %>%
  mutate(date = lubridate::mdy(date)) %>%
  janitor::clean_names() %>%
  group_by(country_region, date) %>%
  summarise(cases = sum(cases)) %>%
  ungroup()

d1
```


```{r eda-covid2019-20}
d1 %>%
  group_by(date) %>%
  summarise(confirmed = sum(cases))
```

ã€WHOï¼š2019å† çŠ¶ç—…æ¯’å…¨çƒå¤§æµè¡Œæ­£åœ¨â€œåŠ é€Ÿâ€ã€‘ä¸–ç•Œå«ç”Ÿç»„ç»‡ï¼ˆWHOï¼‰æ˜¨æ—¥å‘å‡ºè­¦å‘Šï¼ŒæŒ‡2019å† çŠ¶ç—…æ¯’å…¨çƒæ„ŸæŸ“è€…å·²è¶…è¿‡30ä¸‡äººï¼Œå…¨çƒå¤§æµè¡Œæ­£åœ¨â€œåŠ é€Ÿâ€ã€‚ä¸–å«ç»„ç»‡æŒ‡ï¼Œä»é¦–ä¾‹ç—…ä¾‹æŠ¥å‘Šåˆ°æ„ŸæŸ“è€…è¾¾åˆ°10ä¸‡äººç”¨äº†67å¤©ï¼›æ„ŸæŸ“äººæ•°å¢è‡³20ä¸‡ç”¨äº†11å¤©ï¼›ä»20ä¸‡åˆ°çªç ´30ä¸‡åˆ™åªç”¨äº†4å¤©ã€‚

```{r eda-covid2019-21, out.width = '100%'}
d1 %>%
  group_by(date) %>%
  summarise(confirmed = sum(cases)) %>%
  ggplot(aes(x = date, y = confirmed)) +
  geom_point() +
  scale_x_date(
    date_labels = "%m-%d",
    date_breaks = "1 week"
  ) +
  scale_y_continuous(
    breaks = c(0, 50000, 100000, 200000, 300000, 500000, 900000),
    labels = scales::comma
  )
```


```{r eda-covid2019-22}
# d1 %>% distinct(country_region) %>% pull(country_region)
d1 %>% distinct(country_region)
```




```{r eda-covid2019-23}
d1 %>%
  filter(country_region == "China")
```


```{r eda-covid2019-24, out.width = '100%'}
d1 %>%
  filter(country_region == "China") %>%
  ggplot(aes(x = date, y = cases)) +
  geom_point() +
  scale_x_date(date_breaks = "1 week", date_labels = "%m-%d") +
  scale_y_log10(labels = scales::comma)
```





```{r eda-covid2019-25, out.width = '100%'}
d1 %>%
  group_by(country_region) %>%
  filter(max(cases) >= 20000) %>%
  ungroup() %>%
  ggplot(aes(x = date, y = cases, color = country_region)) +
  geom_point() +
  scale_x_date(date_breaks = "1 week", date_labels = "%m-%d") +
  scale_y_log10() +
  facet_wrap(vars(country_region), ncol = 2) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  theme(legend.position = "none")
```


## å¯è§†åŒ–æ¢ç´¢

ç½‘ç«™[https://www.ft.com/coronavirus-latest](https://www.ft.com/coronavirus-latest) è¿™å¼ å›¾å¾ˆå—å…³æ³¨ï¼Œäºæ˜¯æ‰“ç®—é‡å¤


```{r eda-covid2019-26, out.width='85%', fig.align='left', fig.cap='å›¾ç‰‡æ¥æºwww.ft.com', echo=FALSE}
knitr::include_graphics("images/ft_coronavirus.jpg")
```


è¿™å¼ å›¾æƒ³è¡¨è¾¾çš„æ˜¯ï¼Œå‡ºç°100ä¸ªæ¡ˆä¾‹åï¼Œå„å›½ç¡®è¯Šäººæ•°çš„çˆ†å‘è¶‹åŠ¿

- æ¨ªåæ ‡æ˜¯å¤©æ•°ï¼Œå³åœ¨å‡ºç°100ä¸ªæ¡ˆä¾‹åçš„ç¬¬å‡ å¤©
- çºµåæ ‡æ˜¯ç´¯ç§¯ç¡®è¯Šäººæ•°

é‚£ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°æ®çš„**æ—¶é—´è½´**åšç›¸åº”çš„å˜å½¢

- é¦–å…ˆæŒ‰ç…§å›½å®¶åˆ†ç»„
- ç­›é€‰ï¼Œç´¯ç§¯ç¡®è¯Šäººæ•°è¶…è¿‡`100`çš„å›½å®¶
- æ‰¾åˆ°æ‰€æœ‰`case >= 100`çš„æ—¥æœŸï¼Œ`date[cases >= 100]`
- æœ€æ—©çš„æ—¥æœŸï¼Œå°±è¯´æˆ‘ä»¬è¦æ‰¾çš„**ç¬¬ 0 day**ï¼Œ `min(date[cases >= 100])`
- æ„å»ºæ–°çš„ä¸€åˆ—`mutate( days_since_100 = date - min(date[cases >= 100])`
- å°†`days_since_100`è½¬æ¢æˆæ•°å€¼å‹`as.numeric()`

```{r eda-covid2019-27}
d2 <- d1 %>%
  group_by(country_region) %>%
  filter(max(cases) >= 100) %>%
  mutate(
    days_since_100 = date - min(date[cases >= 100])
  ) %>%
  mutate(days_since_100 = as.numeric(days_since_100)) %>%
  filter(days_since_100 >= 0) %>%
  ungroup()
d2
```

```{block eda-covid2019-28, type="danger"}
å¤§å®¶éƒ½è°ˆè¿‡æ‹çˆ±ï¼Œä¹Ÿæœ‰å¯èƒ½å¤±æ‹ã€‚å¤§å®¶å¤±æ‹æ—¶é—´æ˜¯ä¸åŒçš„ï¼Œè‹¥æŠŠå¤±æ‹çš„å½“å¤©ä½œä¸ºç¬¬ 0 day, å°±å¯ä»¥æ¯”è¾ƒå¤±æ‹è‹¥å¹²å¤©åæ¯ä¸ªäººç²¾ç¥æ³¢åŠ¨æƒ…å†µã€‚å‚ç…§ã€Šå¤±æ‹33å¤©ã€‹
```



```{r eda-covid2019-29}
d2_most <- d2 %>%
  group_by(country_region) %>%
  top_n(1, days_since_100) %>%
  filter(cases >= 10000) %>% 
  ungroup() %>% 
  arrange(desc(cases))
d2_most
```




```{r eda-covid2019-30, out.width = "100%"}
d2 %>%
  bind_rows(
    tibble(country = "33% daily rise", days_since_100 = 0:30) %>%
      mutate(cases = 100 * 1.33^days_since_100)
  ) %>%
  
  ggplot(aes(days_since_100, cases, color = country_region)) +
  geom_hline(yintercept = 100) +
  geom_vline(xintercept = 0) +
  geom_line(size = 0.8) +
  geom_point(pch = 21, size = 1) +
#   scale_colour_manual(
#    values = c(
#     "US" = "#EB5E8D",
#     "Italy" = "black", 
#     "Spain" = "#c2b7af",
#     "China" = "red",
#     "Germany" = "#c2b7af",
#     "France" = "#c2b7af",
#     "Iran" = "#9dbf57",
#     "United Kingdom" = "#ce3140",
#     "Korea, South" = "#208fce",
#     "Japan" = "#208fce",
#     "Singapore" = "#1E8FCC",
#      "33% daily rise" = "#D9CCC3",
#     "Switzerland" = "#c2b7af",
#     "Turkey" = "#208fce",
#     "Belgium" = "#c2b7af",
#     "Netherlands" = "#c2b7af",
#     "Austria" = "#c2b7af",
#     "Hong Kong" = "#1E8FCC",
#     # gray
#     "India" = "#c2b7af",
#     "Switzerland" = "#c2b7af",
#     "Belgium" = "#c2b7af",
#     "Norway" = "#c2b7af",
#      "Sweden" = "#c2b7af",
#     "Austria" = "#c2b7af",
#     "Australia" = "#c2b7af",
#     "Denmark" = "#c2b7af",
#     "Canada" = "#c2b7af",
#     "Brazil" = "#c2b7af",
#     "Portugal" = "#c2b7af"
#   )
# ) +
  
  geom_shadowtext(
    data = d2_most, aes(label = paste0("  ", country_region)),
    bg.color = "white"
  ) +
  scale_y_log10(
    expand = expansion(mult = c(0, .1)),
    breaks = c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000),
    labels = scales::comma
  ) +
  scale_x_continuous(
    expand = expansion(mult = c(0, .1)),
    breaks = c(0, 5, 10, 15, 20, 25, 30)
  ) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#FFF1E6"),
    legend.position = "none",
    panel.spacing = margin(3, 15, 3, 15, "mm")
  ) +
  labs(
    x = "Number of days since 100th case",
    y = "",
    title = "Country by country: how coronavirus case trajectories compare",
    subtitle = "Cumulative number of cases, by Number of days since 100th case",
    caption = "data source from @www.ft.com"
  )
```

æœ‰ç‚¹ä¹±ï¼Œè¿˜æœ‰å¾ˆå¤šç»†èŠ‚æ²¡æœ‰å®ç°ï¼Œåé¢å†å¼„å¼„äº†



### ç®€ä¾¿çš„æ–¹æ³•

```{r eda-covid2019-31}
d2a <- d1 %>%
  group_by(country_region) %>%
  filter(cases >= 100) %>%
  mutate(days_since_100 = 0:(n() - 1)) %>%
  # same as
  # mutate(edate = as.numeric(date - min(date)))
  ungroup()
d2a
```

è¿™é‡Œçš„`d2a` å’Œ`d2`æ˜¯ä¸€æ ·çš„äº†ï¼Œä½†æ–¹æ³•ç®€å•å¾ˆå¤šã€‚



### ç–«æƒ…æŒç»­æ—¶é—´æœ€ä¹…çš„å›½å®¶


```{r eda-covid2019-32}
d3 <- d2a %>%
  group_by(country_region) %>%
  filter(days_since_100 == max(days_since_100)) %>%
  # same as
  # top_n(1, days_since_100) %>%
  ungroup() %>%
  arrange(desc(days_since_100))
d3
```

```{r eda-covid2019-33}
highlight <- d3 %>%
  top_n(10, days_since_100) %>%
  pull(country_region)
highlight
```


```{r eda-covid2019-34, out.width = '100%'}
d2a %>%
  bind_rows(
    tibble(country = "33% daily rise", days_since_100 = 0:30) %>%
      mutate(cases = 100 * 1.33^days_since_100)
  ) %>%
  ggplot(aes(days_since_100, cases, color = country_region)) +
  geom_hline(yintercept = 100) +
  geom_vline(xintercept = 0) +
  geom_line(size = 0.8) +
  geom_point(pch = 21, size = 1) +
  scale_y_log10(
    expand = expansion(mult = c(0, .1)),
    breaks = c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000),
    labels = scales::comma
  ) +
  scale_x_continuous(
    expand = expansion(mult = c(0, .1)),
    breaks = c(0, 5, 10, 15, 20, 25, 30, 40, 50, 60)
  ) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#FFF1E6"),
    legend.position = "none",
    panel.spacing = margin(3, 15, 3, 15, "mm")
  ) +
  labs(
    x = "Number of days since 100th case",
    y = "",
    title = "Country by country: how coronavirus case trajectories compare",
    subtitle = "Cumulative number of cases, by Number of days since 100th case",
    caption = "data source from @www.ft.com"
  ) +
  gghighlight::gghighlight(country_region %in% highlight,
    label_key = country_region, use_direct_label = TRUE,
    label_params = list(segment.color = NA, nudge_x = 1),
    use_group_by = FALSE
  )
```

ç°è‰²çº¿æ¡çš„å›½å®¶åï¼Œæœ‰ç‚¹ä¸å¥½å¼„ï¼Œåœ¨æƒ³åŠæ³•



### ç¬¨åŠæ³•å§

ç¬¨åŠæ³•ï¼Œå®é™…ä¸Šæ˜¯4å¼ è¡¨å…±åŒå®Œæˆ

```{r eda-covid2019-35}
highlight <- c(
  "China", "Spain", "US", "United Kingdom", "Korea, South",
  "Italy", "Japan", "Singapore", "Germany", "France", "Iran"
)

gray <- c(
  "India", "Switzerland", "Belgium", "Netherlands",
  "Sweden", "Austria", "Australia", "Denmark",
  "Canada", "Brazil", "Portugal"
)

d3_highlight <- d2a %>% filter(country_region %in% highlight)

d3_gray <- d2a %>% filter(country_region %in% gray)
```

  
```{r eda-covid2019-36, out.width = '100%'}
d2a %>%
  ggplot(aes(days_since_100, cases, group = country_region)) +
  geom_hline(yintercept = 100) +
  geom_vline(xintercept = 0) +
  geom_line(size = 0.8, color = "gray70") +
  geom_point(pch = 21, size = 1, color = "gray70") +

  # highlight country
  geom_line(data = d3_highlight, aes(color = country_region)) +
  geom_point(data = d3_highlight, aes(color = country_region)) +
  geom_text(
    data = d3_highlight %>%
      group_by(country_region) %>%
      top_n(1, days_since_100) %>%
      ungroup(),
    aes(color = country_region, label = country_region),
    hjust = 0,
    vjust = 0,
    nudge_x = 0.5
  ) +


  # gray country
  geom_text(
    data = d3_gray %>%
      group_by(country_region) %>%
      top_n(1, days_since_100) %>%
      ungroup(),
    aes(label = country_region),
    color = "gray50",
    hjust = 0,
    vjust = 0,
    nudge_x = 0.5
  ) +
  geom_point(
    data = d3_gray %>%
      group_by(country_region) %>%
      top_n(1, days_since_100) %>%
      ungroup(),
    size = 2,
    color = "gray50"
  ) +
  scale_y_log10(
    expand = expansion(mult = c(0, .1)),
    breaks = c(100, 200, 500, 2000, 5000, 10000, 20000, 50000, 100000, 150000),
    labels = scales::comma
  ) +
  scale_x_continuous(
    expand = expansion(mult = c(0, .1)),
    breaks = c(0, 5, 10, 15, 20, 25, 30, 40, 50, 60)
  ) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#FFF1E6"),
    legend.position = "none",
    panel.spacing = margin(3, 15, 3, 15, "mm")
  ) +
  labs(
    x = "Number of days since 100th case",
    y = "",
    title = "Country by country: how coronavirus case trajectories compare",
    subtitle = "Cumulative number of cases, by Number of days since 100th case",
    caption = "data source from @www.ft.com"
  )
```

å·®å¼ºäººæ„ï¼Œå†æƒ³æƒ³æœ‰æ²¡æœ‰å¥½çš„åŠæ³•



### æ¯”è¾ƒtidyçš„æ–¹æ³•

å¯¹æ•°æ®æ¡†d2aå¢åŠ ä¸¤åˆ—å±æ€§(æœ‰æ— æ ‡ç­¾ï¼Œæœ‰æ— é¢œè‰²)ï¼Œç„¶åæ‰‹åŠ¨æ”¹é¢œè‰²


```{r eda-covid2019-37}
highlight_country <- d2a %>%
  group_by(country_region) %>%
  filter(days_since_100 == max(days_since_100)) %>%
  ungroup() %>%
  arrange(desc(days_since_100)) %>% 
  top_n(10, days_since_100) %>%
  pull(country_region)

highlight_country
```


å¸å–äº†[Kieran Healyå¤§ç¥çš„é…è‰²æ–¹æ¡ˆ](https://github.com/kjhealy/covid) 
```{r eda-covid2019-38}
## Colors
cgroup_cols <- c(prismatic::clr_darken(paletteer_d("ggsci::category20_d3"), 0.2)[1:length(highlight_country)], "gray70")
scales::show_col(cgroup_cols)
```



```{r eda-covid2019-39}
d2a %>% 
  group_by(country_region) %>% 
  filter(max(days_since_100) > 9) %>%
  mutate(
    end_label = ifelse(days_since_100 == max(days_since_100), country_region, NA_character_)
  ) %>% 
  mutate(end_label = case_when(country_region %in% highlight_country ~ end_label,
                               TRUE ~ NA_character_), 
         cgroup = case_when(country_region %in% highlight_country ~ country_region, 
                            TRUE ~ "ZZOTHER")) %>% # length(highlight_country) + gray

  
  ggplot(aes(x = days_since_100, y = cases, 
         color = cgroup, label = end_label, 
         group = country_region)) + 
  geom_line(size = 0.8) + 
  geom_text_repel(nudge_x = 1.1,
                  nudge_y = 0.1, 
                  segment.color = NA) + 
  guides(color = FALSE) + 
  scale_color_manual(values = cgroup_cols) +
  scale_y_continuous(labels = scales::comma_format(accuracy = 1), 
                     breaks = 10^seq(2, 8),
                     trans = "log10"
                     ) + 
  labs(x = "Days Since 100 Confirmed Death", 
       y = "Cumulative Number of Deaths (log10 scale)", 
       title = "Cumulative Number of Reported Deaths from COVID-19, Selected Countries", 
    subtitle = "Cumulative number of cases, by Number of days since 100th case",
    caption = "data source from @www.ft.com") 
```

æ„Ÿè§‰è¿™æ ·æ˜¯æœ€å¥½çš„æ–¹æ¡ˆã€‚





## æ¯ä¸ªå›½å®¶çš„æƒ…å†µ
```{r eda-covid2019-40}
d2 %>%
  group_by(country_region) %>%
  filter(max(cases) >= 1000) %>%
  ungroup()
```



```{r eda-covid2019-41, out.width = '100%'}
d2 %>%
  group_by(country_region) %>%
  filter(max(cases) >= 1000) %>%
  ungroup() %>%
  ggplot(aes(days_since_100, cases)) +
  geom_line(size = 0.8) +
  geom_line(
    data = d2 %>% rename(country = country_region),
    aes(days_since_100, cases, group = country),
    color = "grey"
  ) +
  geom_point(pch = 21, size = 1, color = "red") +
  scale_y_log10(
    expand = expansion(mult = c(0, .1)),
    breaks = c(100, 1000, 10000, 50000)
  ) +
  scale_x_continuous(
    expand = expansion(mult = c(0, 0)),
    breaks = c(0, 5, 10, 20, 30, 50)
  ) +
  facet_wrap(vars(country_region), scales = "free_x") +
  theme(
    panel.background = element_rect(fill = "#FFF1E6"),
    plot.background = element_rect(fill = "#FFF1E6")
  ) +
  labs(
    x = "Number of days since 100th case",
    y = "",
    title = "Outbreak are now underway in dozens of other countries, with some on the same trajectory as Italy",
    subtitle = "Cumulative number of cases, by Number of days since 100th case",
    caption = "data source from @www.ft.com"
  )
```



## åœ°å›¾ 

```{r eda-covid2019-42, eval=FALSE}
library(countrycode)
# countrycode('Albania', 'country.name', 'iso3c')

d2_newest %>%
  mutate(ISO3 = countrycode(country_region,
    origin = "country.name", destination = "iso3c"
  ))
```



æˆ‘ä»¬é€‰å–æœ€æ–°çš„æ—¥æœŸ
```{r eda-covid2019-43}
d_newest <- d %>%
  select(Long, Lat, last_col()) %>%
  set_names("Long", "Lat", "newest_date")
d_newest
```


```{r eda-covid2019-44, out.width = '100%'}
world <- map_data("world")


ggplot() +
  geom_polygon(
    data = world,
    aes(x = long, y = lat, group = group),
    fill = "grey", alpha = 0.3
  ) +
  geom_point(
    data = d_newest,
    aes(x = Long, y = Lat, size = newest_date, color = newest_date),
    stroke = F, alpha = 0.7
  ) +
  scale_size_continuous(
    name = "Cases", trans = "log",
    range = c(1, 7),
    breaks = c(1, 20, 100, 1000, 50000),
    labels = c("1-19", "20-99", "100-999", "1,000-49,999", "50,000+")
  ) +
  scale_color_viridis_c(
    option = "inferno",
    name = "Cases",
    trans = "log",
    breaks = c(1, 20, 100, 1000, 50000),
    labels = c("1-19", "20-99", "100-999", "1,000-49,999", "50,000+")
  ) +
  theme_void() +
  guides(colour = guide_legend()) +
  labs(
    title = "Mapping the coronavirus outbreak",
    subtitle = "",
    caption = "Source: JHU Unviersity, CSSE; FT research @www.FT.com"
  ) +
  theme(
    legend.position = "bottom",
    text = element_text(color = "#22211d"),
    plot.background = element_rect(fill = "#ffffff", color = NA),
    panel.background = element_rect(fill = "#ffffff", color = NA),
    legend.background = element_rect(fill = "#ffffff", color = NA)
  )
```

## æ›´å¤š

- å‚è€ƒ (https://www.ft.com/coronavirus-latest)
- (https://covid19datahub.io/)
